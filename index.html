
    justify-content: flex-end;
  }
}

/* Validation states */
.is-valid {
  border-color: var(--success) !important;
}

.is-invalid {
  border-color: var(--primary) !important;
}

/* Save button animation */
#saveWeightBtn:active i {
  transform: scale(0.9);
  transition: transform 0.1s;
}







    /* Jump to bottom button */
    .jump-to-bottom {
      position: fixed;
      right: 2rem;
      bottom: 220px;
      background: var(--primary);
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }
    
    .jump-to-bottom.visible {
      opacity: 1;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
      }
      
      .card {
        height: calc(100vh - 1rem);
      }
      
      .card-header {
        padding: 0.8rem;
      }
      
      .message {
        max-width: 90%;
      }
      
      .chat-box {
        padding: 0.8rem;
        height: calc(100vh - 300px);
        max-height: calc(100vh - 300px);
      }
      
      .input-section {
        bottom: 0.5rem;
        left: 0.5rem;
        right: 0.5rem;
        max-width: calc(100% - 1rem);
      }
      
      .chat-container {
        padding-bottom: 200px;
      }
      
      .jump-to-bottom {
        right: 1rem;
        bottom: 200px;
      }
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.02);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body>
  <div class="container-fluid h-100">
    <div class="card mx-auto h-100">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <div class="logo">
            <div class="logo-icon">
              <i class="fas fa-robot"></i>
            </div>
            <span>Personal Fit Coach</span>
          </div>
          <div class="badge bg-white text-primary rounded-pill px-2 py-1" style="font-size: 0.75rem;">
            <i class="fas fa-bolt me-1"></i> AI Coach / PT
          </div>
        </div>
      </div>
      <div class="card-body p-0 d-flex flex-column">
        <div class="chat-container">
          <div class="chat-box" id="chatDisplay">
            <div class="message message-ai">
              <div class="message-sender">
                <i class="fas fa-robot"></i>
                <span>Personal Fit Coach</span>
              </div>
              <div>Hello Paul! I'm your AI Fitness assistant. How can I help you today?</div>
              <div class="message-time">Just now</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Replace your current input-section div with this: -->
<div class="input-section">
  <div class="mb-2">
    <select id="taskSelector" class="form-select">
      <option value="" disabled selected>Choose an expertise area...</option>
    </select>
  </div>
  
  <div class="mb-2">
    <textarea id="userMessage" class="form-control" rows="2" placeholder="Type your message here..."></textarea>
  </div>
  
  <div class="d-flex justify-content-between align-items-center gap-2">
    <div class="input-group" style="max-width: 180px;">
      <input type="number" id="userWeight" class="form-control" placeholder="Weight" min="30" max="300" step="0.1">
      <select id="weightUnit" class="form-select" style="max-width: 70px;">
        <option value="kg">kg</option>
        <option value="lbs">lbs</option>
      </select>
      <button id="saveWeightBtn" class="btn btn-outline-secondary" type="button">
        <i class="fas fa-save"></i>
      </button>
    </div>
    
    <div class="d-flex gap-2">
      <button id="voiceBtn" class="btn btn-secondary">
        <i class="fas fa-microphone"></i>
      </button>
      <button id="copyBtn" class="btn btn-secondary" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy last response">
        <i class="far fa-copy"></i>
      </button>
      <button id="sendBtn" class="btn btn-primary">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>

  <div class="jump-to-bottom" id="jumpToBottom" title="Jump to latest message">
    <i class="fas fa-arrow-down"></i>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
<script>
const taskOptions = {
  "Exercises": "You are a motivating fitness expert that considers the users age and abilities focusing on maximising the potential of the user to achieve their fitness goals. The user has access to a gym with weights. You give varied, exciting and safe workout advice.",

"Daily Workout Gym": "You are a motivating fitness expert that considers the users age and abilities focusing on maximising the potential of the user to achieve their fitness goals. The user has access to a gym with weights.You give varied, exciting and safe workout advice. You give a 1-hour work plan unless otherwise requested",

"Weekly Workout Gym": "You are a motivating fitness expert that considers the users age and abilities focusing on maximising the potential of the user to achieve their fitness goals. The user has access to a gym with weights.You give varied, exciting and safe workout advice. You give a 1 week work plan unless otherwise requested",

"Monthly Workout Gym": "You are a motivating fitness expert that considers the users age and abilities focusing on maximising the potential of the user to achieve their fitness goals. The user has access to a gym with weights.You give varied, exciting and safe workout advice. You give a 1 month work plan unless otherwise requested",

"Meals": "Act as a nutritional expert. You are a expert in nutrition and food health and safety with a strong understanding of cooking. Giving helpful information about meals and their nutritional content to help support the user to achieve their fitness gols. ",

"General Assistant": "Act as helpful personal assistant. You are a expert in websites, software development and business. ",

"Wellbeing & Balance": "You are a wellness consultant who specializes in personal wellbeing. Paul works long 12hr shifts sometimes long shifts patterns, he spends a lot of time on the computer screen and under stress, he likes to take walks, go to the gym and try new things. Give him daily tips and small actions he can take, and recommend healthy foods to eat."
};

const mainPrompt = "You are a health and fitness expert and a personal trainer. Refer to the user as Paul. Paul is 43 and is interested in body building with the main goal of maintaining his current fitness for longevity. He has a history of ashtma and a shoulder injury which feels better now. Use emoji's and make the responses maximum 400 words.";
let lastResponse = "";
let isTyping = false;
let currentAiMessageDiv = null;
let currentAiMessageContent = "";
let controller = null;

















// Initialize tooltips
const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl);
});

const taskSelector = document.getElementById("taskSelector");
const chatDisplay = document.getElementById("chatDisplay");
const userMessage = document.getElementById("userMessage");
const sendBtn = document.getElementById("sendBtn");
const copyBtn = document.getElementById("copyBtn");
const jumpToBottomBtn = document.getElementById("jumpToBottom");


function formatResponseText(text) {
  let formatted = text
    .replace(/## (.+)/g, '<h3>$1</h3>')
    .replace(/\n\* (.+)/g, '<li>$1</li>')
    .replace(/\n\n/g, '<br><br>')
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>'); // Bold text

  if (formatted.includes("<li>")) {
    formatted = formatted.replace(/(<li>.*?<\/li>)/gms, "<ul>$1</ul>");
    formatted = formatted.replace(/<\/ul>\s*<ul>/g, "");
  }

  return formatted;
}


// Populate task selector
Object.keys(taskOptions).forEach(key => {
  const option = document.createElement("option");
  option.value = key;
  option.textContent = key;
  taskSelector.appendChild(option);
});

// Scroll handling
let isUserScrolling = false;
let scrollTimeout = null;

chatDisplay.addEventListener('scroll', () => {
  isUserScrolling = true;
  clearTimeout(scrollTimeout);
  
  // Show jump to bottom button if not at bottom
  const isAtBottom = chatDisplay.scrollHeight - chatDisplay.scrollTop <= chatDisplay.clientHeight + 50;
  jumpToBottomBtn.classList.toggle('visible', !isAtBottom);
  
  scrollTimeout = setTimeout(() => {
    isUserScrolling = false;
  }, 1000);
});

function scrollToBottom(force = false) {
  if (isUserScrolling && !force) return;
  
  // Use requestAnimationFrame for smoother scrolling
  requestAnimationFrame(() => {
    chatDisplay.scrollTo({
      top: chatDisplay.scrollHeight,
      behavior: 'smooth'
    });
    
    // Hide jump to bottom button after scrolling
    jumpToBottomBtn.classList.remove('visible');
  });
}

jumpToBottomBtn.addEventListener('click', () => {
  scrollToBottom(true);
});

function showTypingIndicator() {
  if (isTyping) return;
  isTyping = true;
  const typingDiv = document.createElement("div");
  typingDiv.className = "typing-indicator mb-2";
  typingDiv.innerHTML = `<span></span><span></span><span></span>`;
  chatDisplay.appendChild(typingDiv);
  scrollToBottom();
}

function hideTypingIndicator() {
  isTyping = false;
  const typingIndicator = chatDisplay.querySelector(".typing-indicator");
  if (typingIndicator) typingIndicator.remove();
}

function getCurrentTime() {
  const now = new Date();
  return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function addMessage(sender, message, isUser = false) {
  const messageDiv = document.createElement("div");
  messageDiv.className = `message ${isUser ? 'message-user' : 'message-ai'}`;

  const senderName = isUser ? 'Paul' : 'Kyle';
  const senderIcon = isUser ? 'fas fa-user' : 'fas fa-robot';

  messageDiv.innerHTML = `
    <div class="message-sender">
      <i class="${senderIcon}"></i>
      <span>${senderName}</span>
    </div>
   <div>${isUser ? message : formatResponseText(message)}</div>

    <div class="message-time">${getCurrentTime()}</div>`;

  chatDisplay.appendChild(messageDiv);
  scrollToBottom();

  if (!isUser) {
    lastResponse = message;
  }
}

function abortOngoingRequest() {
  if (controller) {
    controller.abort();
    controller = null;
  }
}

sendBtn.addEventListener("click", async () => {
  const message = userMessage.value.trim();
  if (!message) return;

  const task = taskSelector.value;
  if (!task) {
    alert("Please select an expertise area first");
    return;
  }

  // Combine main prompt + task-specific prompt to form the system prompt
  const systemPrompt = `${mainPrompt} ${taskOptions[task]}`;

  addMessage("user", message, true);
  userMessage.value = "";

  abortOngoingRequest();
  controller = new AbortController();

  showTypingIndicator();

  try {
    const payload = {
      prompt: systemPrompt,
      message: message,
      stream: false  // Force stream to false
    };

    console.log("Sending payload:", payload); // Debug log

    const res = await fetch("https://vclimsoiivmiyhw3372u3besz40guwuo.lambda-url.eu-west-2.on.aws/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify(payload),
      signal: controller.signal
    });

    if (!res.ok) {
      const errorBody = await res.text();
      console.error("Server error:", errorBody);
      throw new Error(`HTTP ${res.status}: ${errorBody}`);
    }

    const data = await res.json();
    lastResponse = data.reply;
    addMessage("ai", data.reply);

  } catch (error) {
    if (error.name === 'AbortError') {
      console.log('Request was aborted');
    } else {
      console.error("Fetch error:", error);
      addMessage("ai", `Error: ${error.message}`);
    }
  } finally {
    hideTypingIndicator();
    controller = null;
  }
});

userMessage.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendBtn.click();
  }
});

copyBtn.addEventListener("click", () => {
  if (!lastResponse) {
    const tooltip = bootstrap.Tooltip.getInstance(copyBtn);
    tooltip.setContent({ '.tooltip-inner': 'No response to copy' });
    tooltip.show();
    setTimeout(() => tooltip.hide(), 2000);
    return;
  }

  navigator.clipboard.writeText(lastResponse).then(() => {
    const tooltip = bootstrap.Tooltip.getInstance(copyBtn);
    tooltip.setContent({ '.tooltip-inner': 'Copied!' });
    tooltip.show();
    setTimeout(() => tooltip.hide(), 2000);
  });
});

// Initial scroll to bottom
window.addEventListener('load', () => {
  scrollToBottom(true);
});

window.addEventListener('beforeunload', () => {
  abortOngoingRequest();
});
</script>


<script>
  // Weight tracking variables
let userWeight = null;
let weightUnit = 'kg';

// DOM elements
const userWeightInput = document.getElementById('userWeight');
const weightUnitSelect = document.getElementById('weightUnit');

// Load weight from localStorage if available
if (localStorage.getItem('userWeight')) {
  userWeight = parseFloat(localStorage.getItem('userWeight'));
  weightUnit = localStorage.getItem('weightUnit') || 'kg';
  userWeightInput.value = userWeight;
  weightUnitSelect.value = weightUnit;
  userWeightInput.classList.add('is-valid');
}

// Update weight when changed
function updateWeight() {
  const value = parseFloat(userWeightInput.value);
  if (!isNaN(value) && value >= 30 && value <= 300) {
    userWeight = value;
    weightUnit = weightUnitSelect.value;
    
    // Visual feedback
    userWeightInput.classList.remove('is-invalid');
    userWeightInput.classList.add('is-valid');
    
    // Store in localStorage
    localStorage.setItem('userWeight', userWeight);
    localStorage.setItem('weightUnit', weightUnit);
  } else if (userWeightInput.value === '') {
    userWeight = null;
    userWeightInput.classList.remove('is-invalid', 'is-valid');
  } else {
    userWeightInput.classList.add('is-invalid');
  }
}

// Event listeners for weight input
userWeightInput.addEventListener('change', updateWeight);
weightUnitSelect.addEventListener('change', updateWeight);

// Modify your main prompt to include weight
const mainPrompt = `You are a health and fitness expert and a personal trainer. Refer to the user as Paul. Paul is 43 and is interested in body building with the main goal of maintaining his current fitness for longevity. ${userWeight ? `Paul currently weighs ${userWeight}${weightUnit}.` : ''} He has a history of asthma and a shoulder injury which feels better now. Use emoji's and make the response displayed well for the user.`;







  
</script>




<script>
  // Voice recognition and read-aloud functionality
const voiceBtn = document.createElement('button');
voiceBtn.id = 'voiceBtn';
voiceBtn.className = 'btn btn-secondary me-2';
voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
voiceBtn.title = 'Voice input (click to toggle) - Active mode will read responses aloud';
document.querySelector('.d-flex.justify-content-end.gap-2').prepend(voiceBtn);

const voiceBtnElement = document.getElementById('voiceBtn');
let recognition = null;
let voiceModeActive = false; // Tracks if voice mode is active (for read-aloud)
let currentUtterance = null; // Tracks the current speech synthesis

// Check for speech recognition support
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = 'en-US';
  
  // Toggle voice mode on button click
  voiceBtnElement.addEventListener('click', (e) => {
    e.preventDefault();
    
    // Toggle voice mode
    voiceModeActive = !voiceModeActive;
    
    if (voiceModeActive) {
      // Activate voice mode (orange color to indicate active)
      voiceBtnElement.classList.add('listening');
      voiceBtnElement.innerHTML = '<i class="fas fa-microphone-alt"></i>';
      voiceBtnElement.style.backgroundColor = 'var(--primary)';
      voiceBtnElement.style.borderColor = 'var(--primary)';
      voiceBtnElement.style.color = 'white';
      
      // Speak the last response if available
      if (lastResponse) {
        speakResponse(lastResponse);
      }
    } else {
      // Deactivate voice mode
      voiceBtnElement.classList.remove('listening');
      voiceBtnElement.innerHTML = '<i class="fas fa-microphone"></i>';
      voiceBtnElement.style.backgroundColor = '';
      voiceBtnElement.style.borderColor = '';
      voiceBtnElement.style.color = '';
      
      // Stop any ongoing speech
      if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
      }
    }
  });
  
  // Separate click handler for microphone (hold to record)
  voiceBtnElement.addEventListener('mousedown', (e) => {
    if (e.button !== 0) return; // Only left click
    if (!voiceModeActive) return;
    
    recognition.start();
    voiceBtnElement.innerHTML = '<i class="fas fa-microphone-slash"></i>';
    voiceBtnElement.style.backgroundColor = 'var(--primary-dark)';
    
    // Show visual feedback for mobile
    if (/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
      showMobileVoiceFeedback();
    }
  });
  
  voiceBtnElement.addEventListener('mouseup', () => {
    if (recognition && recognition.ongoing) {
      recognition.stop();
    }
    if (voiceModeActive) {
      voiceBtnElement.innerHTML = '<i class="fas fa-microphone-alt"></i>';
      voiceBtnElement.style.backgroundColor = 'var(--primary)';
    }
  });
  
  // For touch devices
  voiceBtnElement.addEventListener('touchstart', (e) => {
    if (!voiceModeActive) return;
    e.preventDefault();
    recognition.start();
    voiceBtnElement.innerHTML = '<i class="fas fa-microphone-slash"></i>';
    voiceBtnElement.style.backgroundColor = 'var(--primary-dark)';
    showMobileVoiceFeedback();
  });
  
  voiceBtnElement.addEventListener('touchend', () => {
    if (recognition && recognition.ongoing) {
      recognition.stop();
    }
    if (voiceModeActive) {
      voiceBtnElement.innerHTML = '<i class="fas fa-microphone-alt"></i>';
      voiceBtnElement.style.backgroundColor = 'var(--primary)';
    }
  });
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    userMessage.value = transcript;
    
    // Auto-submit if voice mode is active
    if (voiceModeActive && transcript.trim().length > 0) {
      setTimeout(() => sendBtn.click(), 300);
    }
  };
  
  recognition.onerror = (event) => {
    console.error('Speech recognition error', event.error);
    if (voiceModeActive) {
      voiceBtnElement.innerHTML = '<i class="fas fa-microphone-alt"></i>';
      voiceBtnElement.style.backgroundColor = 'var(--primary)';
    }
    removeMobileVoiceFeedback();
  };
  
  recognition.onend = () => {
    if (voiceModeActive) {
      voiceBtnElement.innerHTML = '<i class="fas fa-microphone-alt"></i>';
      voiceBtnElement.style.backgroundColor = 'var(--primary)';
    }
    removeMobileVoiceFeedback();
  };
  
} else {
  voiceBtnElement.disabled = true;
  voiceBtnElement.title = 'Voice features not supported in this browser';
  new bootstrap.Tooltip(voiceBtnElement);
}

// Function to speak the response
function speakResponse(text) {
  if (!voiceModeActive || !('speechSynthesis' in window)) return;
  
  // Clean the text from HTML tags
  const cleanText = text.replace(/<[^>]*>/g, '');
  
  // Stop any ongoing speech
  window.speechSynthesis.cancel();
  
  currentUtterance = new SpeechSynthesisUtterance(cleanText);
  currentUtterance.rate = 1.0;
  currentUtterance.pitch = 1.0;
  currentUtterance.volume = 1.0;
  
  currentUtterance.onend = () => {
    currentUtterance = null;
  };
  
  currentUtterance.onerror = (e) => {
    console.error('Speech synthesis error:', e);
    currentUtterance = null;
  };
  
  window.speechSynthesis.speak(currentUtterance);
}

// Mobile feedback functions
function showMobileVoiceFeedback() {
  const existing = document.getElementById('mobileVoiceFeedback');
  if (existing) return;
  
  const feedback = document.createElement('div');
  feedback.id = 'mobileVoiceFeedback';
  feedback.style.position = 'fixed';
  feedback.style.top = '50%';
  feedback.style.left = '50%';
  feedback.style.transform = 'translate(-50%, -50%)';
  feedback.style.backgroundColor = 'rgba(0,0,0,0.7)';
  feedback.style.color = 'white';
  feedback.style.padding = '20px';
  feedback.style.borderRadius = '10px';
  feedback.style.zIndex = '9999';
  feedback.style.textAlign = 'center';
  feedback.innerHTML = `
    <i class="fas fa-microphone fa-3x mb-3" style="color: var(--primary)"></i>
    <p style="font-size: 1.2rem; margin: 0;">Listening...</p>
    <p style="font-size: 0.9rem; opacity: 0.8;">Release to stop</p>
  `;
  document.body.appendChild(feedback);
}

function removeMobileVoiceFeedback() {
  const feedback = document.getElementById('mobileVoiceFeedback');
  if (feedback) feedback.remove();
}

// Modify the addMessage function to auto-read when voice mode is active
const originalAddMessage = addMessage;
addMessage = function(sender, message, isUser = false) {
  originalAddMessage(sender, message, isUser);
  
  if (!isUser && voiceModeActive) {
    speakResponse(message);
  }
};

// Stop speech when the page is hidden
document.addEventListener('visibilitychange', () => {
  if (document.hidden && currentUtterance) {
    window.speechSynthesis.cancel();
  }
});
  
</script>

</body>
</html>
